name: Build x64dbg Plugin

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake (Both architectures)
      run: cmake -B build -G "Visual Studio 17 2022" -DBUILD_BOTH_ARCHES=ON

    - name: Build 32-bit and 64-bit plugins
      run: cmake --build build --config Release --target all_plugins

    - name: List build outputs
      run: |
        echo "=== 32-bit plugin ==="
        dir build\build32\Release\
        echo "=== 64-bit plugin ==="
        dir build\build64\Release\

    - name: Upload 32-bit plugin
      uses: actions/upload-artifact@v4
      with:
        name: MCPx64dbg-x32
        path: build/build32/Release/MCPx64dbg.dp32
        if-no-files-found: warn

    - name: Upload 64-bit plugin
      uses: actions/upload-artifact@v4
      with:
        name: MCPx64dbg-x64
        path: build/build64/Release/MCPx64dbg.dp64
        if-no-files-found: warn

    - name: Upload all plugins (combined)
      uses: actions/upload-artifact@v4
      with:
        name: MCPx64dbg-all
        path: |
          build/build32/Release/MCPx64dbg.dp32
          build/build64/Release/MCPx64dbg.dp64
        if-no-files-found: warn

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: MCPx64dbg-all
        path: plugins

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          plugins/MCPx64dbg.dp32
          plugins/MCPx64dbg.dp64
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
